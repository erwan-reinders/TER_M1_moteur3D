<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
    <title>Scene Basique</title>

    <!-- ==================== FONT ==================== -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- ==================== CSS ==================== -->
    <link rel="stylesheet" href="CSS/WebGL.css" />

    <!-- ==================== SHADERS ==================== -->
    <script type="x-shader/x-vertex" id="vshader-texture">
    uniform vec2 translation;
    attribute vec2 a_coords;

    void main() {
        gl_Position = vec4(a_coords + translation, 0, 1);
    }
    </script>
    <script type="x-shader/x-fragment" id="fshader-texture">
    precision mediump float;
    uniform vec4 color;
    void main() {
        gl_FragColor = color;
    }
    </script>

    <!-- Shader program for the on-screen image -->
    <script type="x-shader/x-vertex" id="vshader">
    attribute vec3 a_coords;
    attribute vec3 a_normal;
    attribute vec2 a_texCoords;

    uniform mat4 modelview;
    uniform mat4 projection;
    uniform float textureScale;

    uniform mat3 transformation;
    uniform vec3 translation;

    varying vec3 v_normal;
    varying vec3 v_eyeCoords;
    varying vec2 v_texCoords;
    void main() {
        vec4 objectCoords = vec4((a_coords * transformation) + translation,1.0);
        vec4 eyeCoords = modelview * objectCoords;
        gl_Position = projection * eyeCoords;
        v_normal = normalize(a_normal);
        v_eyeCoords = eyeCoords.xyz/eyeCoords.w;
        v_texCoords = textureScale*a_texCoords;
    }
    </script>
    <script type="x-shader/x-fragment" id="fshader">
    #ifdef GL_FRAGMENT_PRECISION_HIGH
       precision highp float;
    #else
       precision mediump float;
    #endif
    uniform mat3 normalMatrix;
    uniform sampler2D texture;
    varying vec3 v_normal;
    varying vec3 v_eyeCoords;
    varying vec2 v_texCoords;
    void main() {
        vec3 N = normalize( normalMatrix*v_normal );
        vec3 L = normalize( -v_eyeCoords);
        float diffuseFactor = dot(N,L);
        vec4 color = texture2D(texture, v_texCoords);
        gl_FragColor = vec4( diffuseFactor*color.rgb, 1.0);
    }
    </script>

    <script type="text/javascript" defer>
        /**
         * Cette fonction vérifie que la classe est définie, qu'elle a bien été incluse dans le HTML
         * @param required_class : chaîne contenant le nom de la classe ou le fichier .js à inclure
         */
        function Requires(required_class)
        {
            // extraire le nom de la classe : enlever chemin et extension s'il y en a
            let classname = required_class.split("/").pop();
            classname = classname.split(".")[0];

            // cette classe a-t-elle été définie ?
            let ok = true;
            try {
                eval(classname);
            } catch (e) {
                ok = false;
            }
            if (!ok || typeof eval(classname) !== 'function' || eval(classname).hasOwnProperty('arguments')) {

                // récupérer le nom du source JS actuel, il donne le nom de la classe demandeuse
                let scripts = document.getElementsByTagName("script");
                let src = scripts[scripts.length-1].src;
                let caller = src.split("/").pop();

                // page html qui contient le tout
                let page = window.location.href.split("/").slice(-5).join("/");

                // message
                let message = "In "+page+", file "+required_class+" is not included before "+caller+" or is incorrect";
                throw message;
            }
        }
    </script>

    <!-- ==================== JS ==================== -->
    <script type="text/javascript" src="JS/trackball-rotator.js" ></script>
    <script type="text/javascript" src="JS/lib/gl-matrix-min.js" ></script>
    <script type="text/javascript" src="../../v0_test/data/meshes/basic-object-models-IFS.js" ></script>
    <script type="text/javascript" src="../../v0_test/data/meshes/teapot-model-IFS.js" ></script>

    <script type="text/javascript" src="JS/programmeShader.js" ></script>
    <script type="text/javascript" src="JS/Texture.js" ></script>
    <script type="text/javascript" src="JS/TEXTURES/Texture_normale.js" ></script>
    <script type="text/javascript" src="JS/TEXTURES/Texture_image.js" ></script>
    <script type="text/javascript" src="JS/TEXTURES/Texture_nouvelle.js" ></script>
    <script type="text/javascript" src="JS/Model.js" ></script>
    <script type="text/javascript" src="JS/Scene.js"></script>
</head>

<body>

    <h1 class="neon">SCENE BASIQUE</h1>

    <p id="message">Tirer l'objet avec la souris pour le faire tourner</p>


    <noscript><hr><h3>Cette page nécessite Javascript ainsi que d'un navigateur qui supporte WebGL</h3><hr></noscript>

    <div id="options">
        <i id="btn_opt" class="material-icons">settings</i>
        <p class="display_none">
            <label><input type="checkbox" id="animCheckbox"> <b>Animate</b></label>
            <label><b>Texture:</b> <select id="texture">
                <option value="normale">normale</option>
                <option value="nouvelle">nouvelle</option>
                <option value="image">image</option>

            </select></label>
            <label><b>Object:</b> <select id="object">
                <option value="0">Cube</option>
                <option value="1">Sphere</option>
                <option value="2">Cylinder</option>
                <option value="3">Cone</option>
                <option value="4">Torus</option>
                <option value="5">Teapot</option>
                <option value="6">Tetraedre</option>
            </select></label>
            <label id="lb_tscale"><b>Texture Scale: </b><select id="tscale">
                <option>1</option>
                <option>2</option>
                <option>3</option>
            </select></label>
        </p>
    </div>
    <div id="canvas-holder">
        <canvas width=1200 height=600 id="webglcanvas" style="background-color:white"></canvas>
    </div>
</body>

<script type="text/javascript" defer>
    "use strict";

    //Initialisation des var de modeles
    let indice_model = document.getElementById("object").value;
    let modeles = [];

    //Initialisation des var de texture
    let val_text = document.getElementById("texture").value;
    let textures = [];

    //Initialisation de scenes
    let scene = new Scene("webglcanvas");
    scene.init();

    function initialiserScene(b_inittxt){
        if(b_inittxt) initialiserTextures();
        indice_model = document.getElementById("object").value;
        switch (val_text) {
            case "normale" :
                console.log("TXT : NORMALE");
                modeles[indice_model].texture = textures[0];
                break;
            case "nouvelle" :
                console.log("TXT : NOUVELLE");
                modeles[indice_model].texture = textures[1];
                break;
            case "image" :
                console.log("TXT : IMAGE");
                modeles[indice_model].texture = textures[2];
                break;
        }
        scene.clear();
        scene.ajouterModel(modeles[indice_model]);
        scene.initModels();
    }

    function initialiserTextures(){
        textures[0] = new Texture_normale(scene.gl,"vshader-texture", "fshader-texture");
        textures[0].forme.diametre *= document.getElementById("tscale").value;
        textures[1] = new Texture_nouvelle(scene.gl,"vshader-texture", "fshader-texture");
        textures[2] = new Texture_image(scene.gl,"IMG/chouette.png");
    }

    function initialiserModeles(texture, rotator){
        modeles[0] = new Model(scene.gl,cube(),texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
        modeles[1] = new Model(scene.gl,uvSphere(0.7,64,32),texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
        modeles[2] = new Model(scene.gl,uvCylinder(),texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
        modeles[3] = new Model(scene.gl,uvCone(),texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
        modeles[4] = new Model(scene.gl,uvTorus(0.65,0.2,64,24),texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
        let teapot = teapotModel;
        for (let i = 0; i < teapot.vertexPositions.length; i++) {
            teapot.vertexPositions[i] *= 0.05; // scale teapot model to a size that matches other objects
        }
        modeles[5] = new Model(scene.gl,teapot,texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
        modeles[6] = new Model(scene.gl,tetraedre(),texture,"vshader","fshader",scene.gl.drawingBufferHeight,scene.gl.drawingBufferWidth,rotator);
    }

    //Gestion de l'animation
    let animating = false;
    function frame() {
        scene.rendre();
        if (animating) {
            scene.update();
            requestAnimationFrame(frame);
        }
    }

    function doAnimationCheckbox() {
        let run = document.getElementById("animCheckbox").checked;
        if (run != animating) {
            animating = run;
            if (animating)
                requestAnimationFrame(frame);
        }
    }

    //POUR L'INITIALISATION COMPLETE
    function init() {
        let rotator = new TrackballRotator(scene.canvas, function() {
            if (!animating)
                scene.rendre();
        }, 5, [2,2,3]);

        try {
            initialiserTextures();
            initialiserModeles(textures[0],rotator);
            initialiserScene(true);
        }
        catch (e) {
            document.getElementById("canvas-holder").innerHTML =
                "<p>Sorry, could not initialize the WebGL graphics context:" + e + "</p>";
            return;
        }

        document.getElementById("animCheckbox").checked = false;
        document.getElementById("animCheckbox").onchange = doAnimationCheckbox;
        document.getElementById("lb_tscale").style.display = "inline-block";

        document.getElementById("texture").onchange = function (){
            let v = this.value;
            if(v !== val_text) {
                val_text = v;
                if(v === "normale"){
                    document.getElementById("lb_tscale").style.display = "inline-block";
                }else{
                    document.getElementById("lb_tscale").style.display = "none";
                }
                initialiserScene(true);
                frame();
            }
        };
        document.getElementById("object").onchange = function (){
            let v = this.value;
            if(v !== val_text) {
                initialiserScene(false);
                frame();
            }
        };
        document.getElementById("tscale").onchange = function (){
            initialiserScene(true);
            frame();
        };
        frame();
    }

    window.onload = init;


    //Gestion bouton option
    let button_option = document.getElementById("btn_opt");
    let option = document.getElementById("options").getElementsByTagName("p");

    button_option.onclick = function () {
        if(option[0].classList.contains("display_none")) {
            option[0].style.display = "inline-block";
            option[0].classList.remove("display_none");
        }else{
            option[0].style.display = "none";
            option[0].classList.add("display_none");
        }
    };

    //gestion des eventListener
    document.addEventListener('keydown', (event) => {
        switch (event.code){
            case "KeyW" :
                scene.translation(vec3.fromValues(0,.1,0));
                scene.rendre();
                break;
            case "KeyA" :
                scene.translation(vec3.fromValues(-.1,0,0));
                scene.rendre();
                break;
            case "KeyS" :
                scene.translation(vec3.fromValues(0,-.1,0));
                scene.rendre();
                break;
            case "KeyD" :
                scene.translation(vec3.fromValues(.1,0,0));
                scene.rendre();
                break;
            case "KeyQ" :
                scene.translation(vec3.fromValues(0,0,.1));
                scene.rendre();
                break;
            case "KeyE" :
                scene.translation(vec3.fromValues(0,0,-.1));
                scene.rendre();
                break;
            case "KeyC" :
                scene.reset();
                scene.rendre();
                break;
        }
    });
</script>

</html>

