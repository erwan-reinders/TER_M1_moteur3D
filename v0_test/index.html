<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script type="text/javascript" src="lib/gl-matrix-min.js" ></script>
    <script type="text/javascript" src="data/meshes/basic-object-models-IFS.js" ></script>
    <script type="text/javascript" src="data/meshes/teapot-model-IFS.js" ></script>

    <script type="text/javascript" src="js/util.js" ></script>
    <script type="text/javascript" src="js/framebuffer.js" ></script>
    <script type="text/javascript" src="js/texture.js" ></script>
    <script type="text/javascript" src="js/model.js" ></script>
    <script type="text/javascript" src="js/camera.js" ></script>
    <script type="text/javascript" src="js/Light.js" ></script>
    <script type="text/javascript" src="js/scene.js"></script>
    <script type="text/javascript" src="js/controller.js"></script>
    <script type="text/javascript" src="js/shaderProgram.js"></script>

</head>
<body>
    <div id="canvas-holder">
        <canvas width=1200 height=600 id="webglcanvas" style="background-color:white"></canvas>
    </div>

    <script type="text/javascript" defer>
        let shaders;

        let scene;

        function init(){
            message.informative("INITIALISATION", "initialisation of the scene");
            initGl("webglcanvas");
            
            shaders = new Map();

            //BLINN PHONG
            let s = new ShaderProgram("MVPVertexShader.glsl", "BlinnPhongFragmentShader.glsl");
            s.use();
            // uniform for vertex shader
            s.setUniform("uModelMatrix",      valType.Mat4fv);
            s.setUniform("uViewMatrix",       valType.Mat4fv);
            s.setUniform("uProjectionMatrix", valType.Mat4fv);
            s.setUniform("uNormalMatrix",     valType.Mat4fv);

            // uniform for fragment shader
            s.setUniform("uViewPos",    valType.f3v);
            s.setUniform("uLightPos",   valType.f3v);
            s.setUniform("uLightColor", valType.f3v);

            s.setUniform("uObjectColor", valType.f3v);
            s.setUniform("uShininess",   valType.f1);

            s.setAllPos();

            s.setUpdateRenderUniformFunction(function (scene) {
                this.setUniformValueByName("uViewPos",    scene.current_camera.position);
                this.setUniformValueByName("uLightPos",   scene.current_light.position);
                this.setUniformValueByName("uLightColor", scene.current_light.color);
                
                this.setUniformValueByName("uObjectColor", vec3.clone([1.0, 0.0, 1.0]));
                this.setUniformValueByName("uShininess",   16.0);
            })

            shaders.set("blinnPhong", s);

            //TEXTURE
            s = new ShaderProgram("MVPVertexShader.glsl", "TextureBrutFragmentShader.glsl");
            s.use();
            // uniform for vertex shader
            s.setUniform("uModelMatrix",      valType.Mat4fv);
            s.setUniform("uViewMatrix",       valType.Mat4fv);
            s.setUniform("uProjectionMatrix", valType.Mat4fv);
            s.setUniform("uNormalMatrix",     valType.Mat4fv);

            // uniform for fragment shader
            s.setUniform("uSampler",   valType.i1);

            s.setAllPos();

            s.texture = getTextureImage("data/img/chouette.png");
            s.setUpdateRenderUniformFunction(function (scene) {
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, this.texture);
                this.setUniformValueByName("uSampler", 0);
            })

            shaders.set("texture", s);



            //shaders.set("error", new ShaderProgram("test","fs"));
        }

        let controler;
        function main() {
            init();
            scene = new Scene("webglcanvas");
            scene.addModel(new Model(cube(), null, "blinnPhong", gl.drawingBufferHeight, gl.drawingBufferWidth));
            scene.models[0].matrix.modelMatrix = mat4.clone([1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0]);
            scene.addModel(new Model(cube(), null, "texture", gl.drawingBufferHeight, gl.drawingBufferWidth));
            scene.initModels();

            controler = new Controller(scene);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);

            frame();
        }

        function onKeyDown(event) {
            controler.onKeyDown(event);
        }
        function onKeyUp(event) {
            controler.onKeyUp(event);
        }
        function onMouseMove(event) {
            controler.onMouseMove(event);
        }
        function onMouseDown(event) {
            controler.onMouseDown(event);
        }
        function onMouseUp(event) {
            controler.onMouseUp(event);
        }

        function frame() {
            controler.processInput();
            scene.render();
            requestAnimationFrame(frame);
        }

        window.onload = main;
    </script>
</body>
</html>