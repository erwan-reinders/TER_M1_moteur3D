<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script type="text/javascript" src="lib/gl-matrix-min.js" ></script>
    <script type="text/javascript" src="data/meshes/basic-object-models-IFS.js" ></script>
    <script type="text/javascript" src="data/meshes/teapot-model-IFS.js" ></script>

    <script type="text/javascript" src="js/util.js" ></script>
    <script type="text/javascript" src="js/framebuffer.js" ></script>
    <script type="text/javascript" src="js/texture.js" ></script>
    <script type="text/javascript" src="js/model.js" ></script>
    <script type="text/javascript" src="js/camera.js" ></script>
    <script type="text/javascript" src="js/Light.js" ></script>
    <script type="text/javascript" src="js/scene.js"></script>
    <script type="text/javascript" src="js/controller.js"></script>
    <script type="text/javascript" src="js/shaderProgram.js"></script>

</head>
<body>
    <div id="canvas-holder">
        <canvas width=1200 height=600 id="webglcanvas" style="background-color:white"></canvas>
    </div>

    <script id="vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;
        layout (location=0) in vec3 aVertexPosition;
        layout (location=1) in vec3 aVertexNormal;
        layout (location=2) in vec2 aVertexUV;

        uniform mat4 uNormalMatrix;
        uniform mat4 uViewMatrix;
        uniform mat4 uModelMatrix;
        uniform mat4 uModelViewMatrix;
        uniform mat4 uProjectionMatrix;

        out vec3 vNormal;
        out vec3 vFragPos;
        out vec2 vFragUV;

        void main(void) {
            vFragPos = vec3(uModelMatrix * vec4(aVertexPosition, 1.0));
            vNormal = vec3(uNormalMatrix * vec4(aVertexNormal, 1.0));
            vFragUV = aVertexUV;

            gl_Position = uProjectionMatrix * uViewMatrix * vec4(vFragPos, 1.0);
        }
    </script>
    <script id="fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;
        // Fragment-Interpolated data
        in vec3 vNormal;
        in vec3 vFragPos;
        in vec2 vFragUV;

        // Camera
        uniform vec3 uViewPos;
        // Light
        uniform vec3 uLightPos;
        uniform vec3 uLightColor;

        // Material
        uniform vec3 uObjectColor;
        uniform float uShininess;
        // uniform sampler2D uSampler;// texture

        out vec4 FragColor;

        void main(void) {
            // highp vec4 texelColor = texture2D(uSampler, vTextureCoord);

            // ambient
            float ambientStrength = 0.1;
            vec3 ambient = ambientStrength * uObjectColor;

            // diffuse
            vec3 norm = normalize(vNormal);
            vec3 lightDir = normalize(uLightPos - vFragPos);
            float diff = max(dot(norm, lightDir), 0.0);
            vec3 diffuse = diff * uLightColor * uObjectColor;

            // specular
            float specularStrength = 0.5;
            vec3 viewDir = normalize(uViewPos - vFragPos);
            vec3 reflectDir = reflect(-lightDir, norm);
            float spec = pow(max(dot(viewDir, reflectDir), 0.0), uShininess);
            vec3 specular = specularStrength * spec * uLightColor;

            vec3 result = ambient + diffuse + specular;
            FragColor = vec4(result, 1.0);
        }
    </script>

    <script type="text/javascript" defer>
        let shaders = [
            new ShaderProgram("vs","fs"),
            new ShaderProgram("test","fs"),
        ];

        let scene;

        function init(){
            message.informative("INITIALISATION", "initialisation of the scene");
            initGl("webglcanvas");
            shaders.forEach(el => el.init());
        }

        let controler;
        function main() {
            init();
            scene = new Scene("webglcanvas");
            scene.addModel(new Model(cube(), null, "vs", "fs", gl.drawingBufferHeight, gl.drawingBufferWidth));
            scene.initModels();
            frame();

            controler = new Controller(scene);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);

            frame();
        }

        function onKeyDown(event) {
            controler.onKeyDown(event);
        }
        function onKeyUp(event) {
            controler.onKeyUp(event);
        }
        function onMouseMove(event) {
            controler.onMouseMove(event);
        }
        function onMouseDown(event) {
            controler.onMouseDown(event);
        }
        function onMouseUp(event) {
            controler.onMouseUp(event);
        }

        function frame() {
            controler.processInput();
            scene.render();
            requestAnimationFrame(frame);
        }

        window.onload = main;
    </script>
</body>
</html>