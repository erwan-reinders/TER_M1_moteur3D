<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TER M1</title>

    <!-- ================================== FONTS AND ICONS ================================== -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Materialize
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    -->
    <!-- ======================================== CSS ======================================== -->
    <link rel="stylesheet" href="css/general.css" />
    <link rel="stylesheet" href="css/ui.css" />

    <!-- ======================================== JS ========================================== -->
    <!-- LIB -->
    <script type="text/javascript" src="lib/gl-matrix-min.js" ></script>
    <!-- MODELS -->
    <script type="text/javascript" src="data/meshes/basic-object-models-IFS.js" ></script>
    <script type="text/javascript" src="data/meshes/teapot-model-IFS.js" ></script>

    <!-- RENDERING SOURCE CODE -->
    <script type="text/javascript" src="js/util.js" defer></script>
    <script type="text/javascript" src="js/util_ui.js" defer ></script>
    <script type="text/javascript" src="js/framebuffer.js" ></script>

    <!-- RAYCAST BEHAVIOR -->
    <script type="text/javascript" src="js/raycast/line.js" ></script>
    <script type="text/javascript" src="js/raycast/ray.js" ></script>
    <script type="text/javascript" src="js/raycast/collider.js" ></script>
    <script type="text/javascript" src="js/raycast/AABB.js" ></script>
    <script type="text/javascript" src="js/raycast/Sphere.js" ></script>
    <script type="text/javascript" src="js/raycast/OBB.js" ></script>
    <script type="text/javascript" src="js/raycast/pickingController.js" ></script>

    <!-- RENDERING ELEMENTS -->
    <script type="text/javascript" src="js/camera.js" ></script>
    <script type="text/javascript" src="js/model.js" ></script>
    <script type="text/javascript" src="js/light.js" ></script>
    <script type="text/javascript" src="js/scene.js"></script>
    <script type="text/javascript" src="js/shaderProgram.js"></script>
    <script type="text/javascript" src="js/shaderRendererResult.js"></script>
    <script type="text/javascript" src="js/shaderRenderer.js"></script>
    <script type="text/javascript" src="js/shaderPipeline.js"></script>
    <script type="text/javascript" src="js/controller.js"></script>

    <!-- SHADERS PROGRAMS -->
    <script type="text/javascript" src="js/Shaders/chainRenderer.js"></script>
    <script type="text/javascript" src="js/Shaders/GBuffer.js"></script>
    <script type="text/javascript" src="js/Shaders/textureGBuffer.js"></script>
    <script type="text/javascript" src="js/Shaders/applyToScreen.js"></script>
    <script type="text/javascript" src="js/Shaders/blinnPhong.js"></script>
    <script type="text/javascript" src="js/Shaders/blinnPhongAllLight.js"></script>
    <script type="text/javascript" src="js/Shaders/fusion.js"></script>
    <script type="text/javascript" src="js/Shaders/fusionDepth.js"></script>
    <script type="text/javascript" src="js/Shaders/gammaCorrection.js"></script>
    <script type="text/javascript" src="js/Shaders/exposure.js"></script>
    <script type="text/javascript" src="js/Shaders/skybox.js"></script>
    <script type="text/javascript" src="js/Shaders/depthMap.js"></script>
    <script type="text/javascript" src="js/Shaders/shadow.js"></script>
    <script type="text/javascript" src="js/Shaders/kernel.js"></script>
    <script type="text/javascript" src="js/Shaders/extractColorByBrigthness.js"></script>
    <script type="text/javascript" src="js/Shaders/gaussianBlur.js"></script>
    <script type="text/javascript" src="js/Shaders/ssao.js"></script>
    <script type="text/javascript" src="js/Shaders/cubeMapReflexion.js"></script>
    <script type="text/javascript" src="js/Shaders/applyCubeMapToObject.js"></script>
    <script type="text/javascript" src="js/Shaders/colliderShader.js"></script>
    <script type="text/javascript" src="js/Shaders/renderOnCubemap.js"></script>

    <!-- BUILDERS -->
    <script type="text/javascript" src="js/Builders/shaderBuilder.js"></script>
    <script type="text/javascript" src="js/Builders/pipelineBuilder.js"></script>
    <script type="text/javascript" src="js/Builders/sceneBuilder.js"></script>

</head>
<body>

<div id="loadingscreen">
    <p id="loadingtext">
        <span class="span1">C</span>
        <span class="span2">H</span>
        <span class="span3">A</span>
        <span class="span4">R</span>
        <span class="span5">G</span>
        <span class="span6">E</span>
        <span class="span7">M</span>
        <span class="span8">E</span>
        <span class="span9">N</span>
        <span class="span10">T</span>
    </p>

    <div id="title">
        <span>R</span><span>E</span><span>C</span><span>A</span>

        <div class="desc">
            <span>Ange Clément - Reinders Erwan</span>
            <button id="startingbtn">Commencer</button>
        </div>
    </div>

    <!--https://codepen.io/achudars/pen/DWROKx-->
    <div id="loadingbar">
    <div id="main"></div>
    <div class="row" id="r-one">
        <span class="sq" id="sq-1"></span>
        <span class="sq" id="sq-2"></span>
        <span class="sq" id="sq-3"></span>
    </div>
    <div class="row" id="r-two">
        <span class="sq" id="sq-4"></span>
        <span class="sq" id="sq-5"></span>
        <span class="sq" id="sq-6"></span>
    </div>
    <div class="row" id="r-three">
        <span class="sq" id="sq-7"></span>
        <span class="sq" id="sq-8"></span>
        <span class="sq" id="sq-9"></span>
    </div>
    <div class="row" id="r-four">
        <span class="sq" id="sq-10"></span>
        <span class="sq" id="sq-11"></span>
        <span class="sq" id="sq-12"></span>
    </div>
</div>
</div>
    <div id="canvas-holder">
        <!--<canvas width=1200 height=600 id="webglcanvas"></canvas>-->
        <canvas id="webglcanvas" oncontextmenu="return false"></canvas>
    </div>

    <i id="option_icon" class="material-icons">settings</i>
    <div id="options">
        <h1 id="options_title">RENDERING OPTIONS <i id="close_icon" class="material-icons">close</i></h1>
        <div id="options_list">
            <button id="resetAll">Reset all options</button>
        </div>
    </div>
    <div id="stats">
        <div class="stat_element">fps : <span id="fps">0</span></div>
        <div class="stat_element">scene : <span id="scene">0</span></div>
        <div class="stat_element">pipeline : <span id="pipeline">0</span></div>
    </div>

    <script type="text/javascript" defer>
        /*==========================================================================*/
        //=== ELEMENTS DOM
        let dom_canva_holder        = document.getElementById("canvas-holder");
        let dom_options             = document.getElementById("options");
        let dom_options_icon        = document.getElementById("option_icon");
        let dom_options_icon_close  = document.getElementById("close_icon");

        let dom_stats               = document.getElementById("stats");
        let dom_loadingscreen       = document.getElementById("loadingscreen");
        let dom_loadingbar          = document.getElementById("loadingbar");
        let dom_loadingtext         = document.getElementById("loadingtext");
        let dom_loadingtitle        = document.getElementById("title");

        let dom_startButton         = document.getElementById("startingbtn");
        let dom_resetAllButton      = document.getElementById("resetAll");

        /*==========================================================================*/
        //=== VARIABLES GLOBALES
        let updateRender = true;
        let currentScene = 0;
        let currentPipeline = 0;

        let controler;
        let controler_ray;

        let previousTime = 0;
        let deltaTime = 0.01;
        /*==========================================================================*/
        //=== FONCTIONS PRINCIPALES (dont la boucle de rendu)
        function init(){
            message.informative("INITIALISATION", "initialisation of the scene");
            initUi();
            setLoadingPercent(0.1);

            initGl("webglcanvas");
            setLoadingPercent(0.2);

            
            buildShaders();
            setLoadingPercent(0.8);
            
            buildPipelines();
            setLoadingPercent(0.85);
            
            buildScenes();
            setLoadingPercent(0.9);

            pipelines = scenes[currentScene].pipelines;
        }

        function main() {
            init();

            controler = new Controller();
            controler_ray = new PickingController();

            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('wheel', onWheel);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);

            fetchStat("fps");
            fetchStat("scene");
            fetchStat("pipeline");

            stats["pipeline"].innerHTML = (currentPipeline+1) + " / " + pipelines.length;
            stats["scene"].innerHTML = (currentScene+1) + " / " + scenes.length;
        
            setLoadingPercent(1);
            //On doit faire apparaitre d'abord l'écran titre, puis enfin lancer la boucle de rendu
            setTimeout(makeTitleAppear,time_interval_maj);
        }

        function onKeyDown(event) {
            //On ne veut pas bouger si on est dans le menu des options
            if(!isOptionsAvailables()) controler.onKeyDown(event);
        }
        function onKeyUp(event) {
            //On ne veut pas bouger si on est dans le menu des options
            if(!isOptionsAvailables()) controler.onKeyUp(event);
        }
        function onMouseMove(event) {
            //On ne veut pas bouger si on est dans le menu des options
            if(!isOptionsAvailables()) {
                controler.onMouseMove(event);
                controler_ray.onMouseMove(event);
            }
        }
        function onWheel(event) {
            //On ne veut pas bouger si on est dans le menu des options
            if(!isOptionsAvailables()) {
                controler.onWheel(event);
            }
        }
        function onMouseDown(event) {
            //On ne veut pas bouger si on est dans le menu des options
            if(!isOptionsAvailables()) {
                controler.onMouseDown(event);
                controler_ray.onMouseDown(event);
            }
        }
        function onMouseUp(event) {
            //On ne veut pas bouger si on est dans le menu des options
            if(!isOptionsAvailables()) {
                controler.onMouseUp(event);
                controler_ray.onMouseUp(event);
            }
        }

        function frame(time) {
            deltaTime = time - previousTime;
            deltaTime *= 0.001;
            previousTime = time;
            
            controler.processInput();
            if (updateRender) {
                const newDeltaTime = parseInt(1.0 / deltaTime);
                if (Math.abs(newDeltaTime - stats["fps"].innerHTML) > 2) {
                    stats["fps"].innerHTML = newDeltaTime;
                }
                scenes[currentScene].update();
                pipelines[currentPipeline].render(scenes[currentScene]);
            }
            
            requestAnimationFrame(frame);
        }

        function makeTitleAppear(){
            dom_loadingtext.style.display   = "none";
            dom_loadingbar.style.display    = "none";
            dom_loadingtitle.style.display  = "block";
        }

        /*==========================================================================*/
        //=== FONCTIONS POUR LE DEMARRAGE DE L'APPLICATION
        function startPage(){
            setLoadingPercent(0);
            dom_canva_holder.style.display  = "none";
            dom_options.style.display       = "none";
            dom_stats.style.display         = "none";
            dom_loadingtitle.style.display  = "none";
            dom_options_icon.style.display  = "none";

            dom_loadingscreen.style.display = "block";
            dom_loadingtext.style.display   = "block";
            dom_loadingbar.style.display    = "block";

            setTimeout(main,time_interval_maj);
        }

        /* ===== Loading bar animation ===== */
        let main_anim_stretchmax = 600;
        let main_anim_stretchmin = 0;
        let row_anim_squeezmax  = 600;
        let row_anim_squeezmin  = 0;
        let dom_load_rows = document.getElementById("loadingbar").getElementsByClassName("row");
        let dom_load_main = document.getElementById("main");

        let time_interval_maj = 200;

        function setLoadingPercent(percent){
            for (let row of dom_load_rows){
                row.style.width = ((row_anim_squeezmax * (1 - percent)) + row_anim_squeezmin) + "px";
            }
            dom_load_main.style.width = (main_anim_stretchmax * percent + main_anim_stretchmin) + "px";
        }

        function isOptionsAvailables(){
            //console.log(dom_options_icon.style.display);
            return dom_options_icon.style.display !== "block";
        }

        /*==========================================================================*/
        dom_startButton.onclick = function (){
            dom_loadingscreen.classList.add("desappear");
            dom_canva_holder.classList.add("appear");

            dom_canva_holder.style.display  = "block";
            dom_stats.style.display         = "block";

            setTimeout(function (){
                dom_loadingtitle.style.display = "none";
                dom_load_main.style.display = "none";
                dom_options_icon.style.display  = "block";
                requestAnimationFrame(frame);
            }, time_interval_maj);
        }

        //window.onload = main;
        window.onload = startPage;
    </script>
</body>
</html>