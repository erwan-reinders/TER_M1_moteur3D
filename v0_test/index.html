<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TER M1</title>

    <!-- ==================== FONT ==================== -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

    <!-- ==================== CSS ==================== -->
    <link rel="stylesheet" href="css/general.css" />
    <link rel="stylesheet" href="css/ui.css" />

    <!-- ==================== JS ==================== -->
    <!-- LIB -->
    <script type="text/javascript" src="lib/gl-matrix-min.js" ></script>
    <!-- MODELS -->
    <script type="text/javascript" src="data/meshes/basic-object-models-IFS.js" ></script>
    <script type="text/javascript" src="data/meshes/teapot-model-IFS.js" ></script>

    <!-- rendering source code -->
    <script type="text/javascript" src="js/util.js" defer></script>
    <script type="text/javascript" src="js/util_ui.js" defer ></script>
    <script type="text/javascript" src="js/framebuffer.js" ></script>

    <script type="text/javascript" src="js/raycast/line.js" ></script>
    <script type="text/javascript" src="js/raycast/ray.js" ></script>
    <script type="text/javascript" src="js/raycast/collider.js" ></script>
    <script type="text/javascript" src="js/raycast/AABB.js" ></script>
    <script type="text/javascript" src="js/raycast/Sphere.js" ></script>
    <script type="text/javascript" src="js/raycast/OBB.js" ></script>
    <script type="text/javascript" src="js/raycast/pickingController.js" ></script>
    <!--
    <script type="text/javascript" src="js/texture.js" ></script>
    -->
    <script type="text/javascript" src="js/camera.js" ></script>
    <script type="text/javascript" src="js/model.js" ></script>
    <script type="text/javascript" src="js/light.js" ></script>
    <script type="text/javascript" src="js/scene.js"></script>
    <script type="text/javascript" src="js/shaderProgram.js"></script>
    <script type="text/javascript" src="js/shaderRendererResult.js"></script>
    <script type="text/javascript" src="js/shaderRenderer.js"></script>
    <script type="text/javascript" src="js/shaderPipeline.js"></script>
    <script type="text/javascript" src="js/controller.js"></script>
    
    <script type="text/javascript" src="js/Shaders/chainRenderer.js"></script>
    <script type="text/javascript" src="js/Shaders/GBuffer.js"></script>
    <script type="text/javascript" src="js/Shaders/textureGBuffer.js"></script>
    <script type="text/javascript" src="js/Shaders/applyToScreen.js"></script>
    <script type="text/javascript" src="js/Shaders/blinnPhong.js"></script>
    <script type="text/javascript" src="js/Shaders/blinnPhongAllLight.js"></script>
    <script type="text/javascript" src="js/Shaders/fusion.js"></script>
    <script type="text/javascript" src="js/Shaders/fusionDepth.js"></script>
    <script type="text/javascript" src="js/Shaders/gammaCorrection.js"></script>
    <script type="text/javascript" src="js/Shaders/exposure.js"></script>
    <script type="text/javascript" src="js/Shaders/skybox.js"></script>
    <script type="text/javascript" src="js/Shaders/depthMap.js"></script>
    <script type="text/javascript" src="js/Shaders/shadow.js"></script>
    <script type="text/javascript" src="js/Shaders/kernel.js"></script>
    <script type="text/javascript" src="js/Shaders/extractColorByBrigthness.js"></script>
    <script type="text/javascript" src="js/Shaders/gaussianBlur.js"></script>
    <script type="text/javascript" src="js/Shaders/ssao.js"></script>
    <script type="text/javascript" src="js/Shaders/cubeMapReflexion.js"></script>
    <script type="text/javascript" src="js/Shaders/colliderShader.js"></script>

    <script type="text/javascript" src="js/Builders/sceneBuilder.js"></script>
    <script type="text/javascript" src="js/Builders/shaderBuilder.js"></script>
    <script type="text/javascript" src="js/Builders/pipelineBuilder.js"></script>

</head>
<body>
    <div id="canvas-holder">
        <!--<canvas width=1200 height=600 id="webglcanvas"></canvas>-->
        <canvas id="webglcanvas" oncontextmenu="return false"></canvas>
    </div>

    <div id="options">
        <h1 id="options_title">RENDERING OPTIONS</h1>
        <div id="options_list"></div>
    </div>

    <div id="stats">
        <div class="stat_element">fps : <span id="fps">0</span></div>
    </div>

    <script type="text/javascript" defer>

        let updateRender = true;
        let currentScene = 0;
        let currentPipeline = 0;

        let controler;
        let controler_ray;

        let previousTime = 0;
        let deltaTime = 0.01;

        function init(){
            message.informative("INITIALISATION", "initialisation of the scene");
            initUi();
            initGl("webglcanvas");

            buildScenes();

            buildShaders();
            buildPipelines();
        }

        function main() {
            init();

            controler = new Controller();
            controler_ray = new PickingController();

            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('wheel', onWheel);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);

            fetchStat("fps");

            requestAnimationFrame(frame);
        }

        function onKeyDown(event) {
            controler.onKeyDown(event);
        }
        function onKeyUp(event) {
            controler.onKeyUp(event);
        }
        function onMouseMove(event) {
            controler.onMouseMove(event);
            controler_ray.onMouseMove(event);
        }
        function onWheel(event) {
            controler.onWheel(event);
        }
        function onMouseDown(event) {
            controler.onMouseDown(event);
            controler_ray.onMouseDown(event);
        }
        function onMouseUp(event) {
            controler.onMouseUp(event);
            controler_ray.onMouseUp(event);
        }

        function frame(time) {
            deltaTime = time - previousTime;
            deltaTime *= 0.001;
            previousTime = time;
            
            controler.processInput();
            if (updateRender) {
                const newDeltaTime = parseInt(1.0 / deltaTime);
                if (Math.abs(newDeltaTime - stats["fps"].innerHTML) > 2) {
                    stats["fps"].innerHTML = newDeltaTime;
                }
                scenes[currentScene].update();
                pipelines[currentPipeline].render(scenes[currentScene]);
            }
            
            requestAnimationFrame(frame);
        }


        let val = 0;

        window.onload = main;
    </script>
</body>
</html>